<div class="toolbar" role="toolbar" [attr.aria-label]="'toolbar.managementToolbar' | translate"
  [attr.data-has-selection]="hasSelection">
  <div class="toolbar-left">
    <!-- Breadcrumb on mobile (projected content) -->
    <ng-content select="[toolbarBreadcrumb]"></ng-content>

    <!-- Page Title (if provided) -->
    @if(pageTitle && !hasSelection) {
    <div class="page-title-section">
      @if(pageIcon) {
      <mat-icon class="page-icon">{{ pageIcon }}</mat-icon>
      }
      <h1 class="page-title">{{ pageTitle }}</h1>
    </div>
    }

    <!-- Selection info -->
    @if(hasSelection) {
    <div class="selection-info" role="status" aria-live="polite">
      <span>{{ 'toolbar.selected' | translate:{count: selectionCount} }}</span>
      <button mat-icon-button class="clear-selection" (click)="onClearSelection()"
        [matTooltip]="'toolbar.clearSelection' | translate" [attr.aria-label]="'toolbar.clearSelection' | translate">
        <mat-icon aria-hidden="true">close</mat-icon>
      </button>
    </div>
    }

    <!-- Custom action buttons (projected content) -->
    <ng-content select="[toolbarActions]"></ng-content>

    <!-- Action buttons - Desktop: text + icon, Mobile: FAB only -->
    @if(!hasSelection && !isSearchResultsPage) {
    <div class="action-buttons-desktop">
      @if(showUploadButton) {
      <button mat-raised-button color="primary" class="upload-btn" (click)="onUploadFiles()"
        [attr.aria-label]="'toolbar.uploadFiles' | translate">
        <mat-icon aria-hidden="true">cloud_upload</mat-icon>
        <span>{{ 'common.upload' | translate }}</span>
      </button>
      }

      @if(showCreateFolderButton) {
      <button mat-stroked-button class="new-folder-btn" (click)="onCreateFolder()"
        [attr.aria-label]="'toolbar.createNewFolder' | translate">
        <mat-icon aria-hidden="true">create_new_folder</mat-icon>
        <span>{{ 'toolbar.newFolder' | translate }}</span>
      </button>
      }
    </div>

    <!-- Overflow menu for mobile -->
    <button mat-icon-button class="overflow-menu-btn" [matMenuTriggerFor]="overflowMenu"
      [attr.aria-label]="'toolbar.moreOptions' | translate" aria-haspopup="menu">
      <mat-icon aria-hidden="true">more_vert</mat-icon>
    </button>

    <mat-menu #overflowMenu="matMenu" class="overflow-menu">
      <div class="overflow-section-title">{{ 'toolbar.sortBy' | translate }}</div>
      @for(option of sortOptions; track option.value) {
      <button mat-menu-item (click)="onSortChange(option.value)" [class.active]="sortBy === option.value">
        <span>{{ option.labelKey | translate }}</span>
        @if(sortBy === option.value) {
        <mat-icon aria-hidden="true">check</mat-icon>
        }
      </button>
      }
      <mat-divider></mat-divider>
      <button mat-menu-item (click)="toggleSortOrder()">
        <mat-icon aria-hidden="true">{{ sortOrder === 'ASC' ? 'arrow_upward' : 'arrow_downward' }}</mat-icon>
        <span>{{ sortOrder === 'ASC' ? ('toolbar.ascending' | translate) : ('toolbar.descending' | translate) }}</span>
      </button>
    </mat-menu>
    }

    <!-- Selection actions - Desktop: all visible, Mobile: primary + more -->
    @if(hasSelection && showStandardSelectionActions) {
    <!-- Desktop: Traditional horizontal layout -->
    <div class="selection-actions desktop-selection" role="group"
      [attr.aria-label]="'toolbar.managementToolbar' | translate">
      @if(selectionCount === 1) {
      <button mat-stroked-button (click)="onRenameSelected()" [matTooltip]="'toolbar.rename' | translate"
        [attr.aria-label]="'toolbar.renameSelected' | translate">
        <mat-icon aria-hidden="true">edit</mat-icon>
        <span>{{ 'common.rename' | translate }}</span>
      </button>
      }
      <button mat-stroked-button (click)="onDownloadSelected()" [matTooltip]="'toolbar.download' | translate"
        [attr.aria-label]="'toolbar.downloadSelected' | translate">
        <mat-icon aria-hidden="true">download</mat-icon>
        <span>{{ 'common.download' | translate }}</span>
      </button>
      <button mat-stroked-button (click)="onMoveSelected()" [matTooltip]="'toolbar.move' | translate"
        [attr.aria-label]="'toolbar.moveSelected' | translate">
        <mat-icon aria-hidden="true">open_with</mat-icon>
        <span>{{ 'toolbar.move' | translate }}</span>
      </button>
      <button mat-stroked-button (click)="onCopySelected()" [matTooltip]="'toolbar.copy' | translate"
        [attr.aria-label]="'toolbar.copySelected' | translate">
        <mat-icon aria-hidden="true">content_copy</mat-icon>
        <span>{{ 'toolbar.copy' | translate }}</span>
      </button>
      <button mat-stroked-button color="warn" (click)="onDeleteSelected()" [matTooltip]="'toolbar.delete' | translate"
        [attr.aria-label]="'toolbar.deleteSelected' | translate">
        <mat-icon aria-hidden="true">delete</mat-icon>
        <span>{{ 'common.delete' | translate }}</span>
      </button>
    </div>

    <!-- Mobile: Actions button only -->
    <div class="selection-actions mobile-selection" role="group"
      [attr.aria-label]="'toolbar.managementToolbar' | translate">
      <button mat-raised-button color="primary" (click)="toggleBottomSheet()" [attr.aria-expanded]="bottomSheetOpen"
        [attr.aria-label]="'toolbar.actionsFor' | translate:{count: selectionCount}" class="mobile-actions-button">
        <mat-icon aria-hidden="true">checklist</mat-icon>
        <span>{{ 'common.actions' | translate }}</span>
        @if(getAvailableActionsCount() > 0) {
        <span class="action-count-badge">{{ getAvailableActionsCount() }}</span>
        }
      </button>
    </div>
    }
  </div>

  <!-- Pagination Controls (center) - Desktop only -->
  @if(!hasSelection && totalItems > 0) {
  <div class="toolbar-center desktop-only">
    <nav class="pagination-controls" role="navigation" aria-label="Pagination">
      <span class="pagination-info" role="status" aria-live="polite">
        {{ getStartIndex() }}-{{ getEndIndex() }} {{ 'toolbar.of' | translate }} {{ totalItems }}
      </span>

      <!-- Page size selector -->
      <button mat-button [matMenuTriggerFor]="pageSizeMenu" class="page-size-btn"
        [matTooltip]="'toolbar.itemsPerPage' | translate"
        [attr.aria-label]="('toolbar.itemsPerPage' | translate) + ': ' + pageSize" aria-haspopup="menu"
        [attr.aria-expanded]="pageSizeMenuOpen">
        <span>{{ pageSize }}</span>
        <mat-icon aria-hidden="true">expand_more</mat-icon>
      </button>
      <mat-menu #pageSizeMenu="matMenu" class="page-size-menu" (opened)="pageSizeMenuOpen = true"
        (closed)="pageSizeMenuOpen = false">
        @for(size of pageSizeOptions; track size) {
        <button mat-menu-item (click)="onPageSizeChange(size)" [class.active]="size === pageSize"
          class="page-size-option" role="menuitemradio" [attr.aria-checked]="size === pageSize"
          [attr.aria-label]="size + ' ' + ('toolbar.itemsPerPage' | translate)">
          <span class="option-value">{{ size }}</span>
          <span class="option-label">{{ 'toolbar.itemsPerPage' | translate }}</span>
          @if(size === pageSize) {
          <mat-icon class="option-check" aria-hidden="true">check</mat-icon>
          }
        </button>
        }
      </mat-menu>

      <button mat-icon-button class="pagination-btn" [disabled]="!hasPreviousPage()" (click)="onPreviousPage()"
        [matTooltip]="'toolbar.previousPage' | translate" [attr.aria-label]="'toolbar.previousPage' | translate">
        <mat-icon aria-hidden="true" class="rtl-flip">chevron_left</mat-icon>
      </button>
      <button mat-icon-button class="pagination-btn" [disabled]="!hasNextPage()" (click)="onNextPage()"
        [matTooltip]="'toolbar.nextPage' | translate" [attr.aria-label]="'toolbar.nextPage' | translate">
        <mat-icon aria-hidden="true" class="rtl-flip">chevron_right</mat-icon>
      </button>
    </nav>
  </div>
  }

  <div class="toolbar-right">
    <!-- View toggle - always visible -->
    <div class="view-toggle" role="group" aria-label="View mode toggle">
      <button mat-icon-button [class.active]="viewMode === 'grid'" (click)="viewMode !== 'grid' && toggleViewMode()"
        [matTooltip]="'toolbar.gridView' | translate" [attr.aria-label]="'toolbar.gridView' | translate"
        [attr.aria-pressed]="viewMode === 'grid'">
        <mat-icon aria-hidden="true">grid_view</mat-icon>
      </button>
      <button mat-icon-button [class.active]="viewMode === 'list'" (click)="viewMode !== 'list' && toggleViewMode()"
        [matTooltip]="'toolbar.listView' | translate" [attr.aria-label]="'toolbar.listView' | translate"
        [attr.aria-pressed]="viewMode === 'list'">
        <mat-icon aria-hidden="true">view_list</mat-icon>
      </button>
    </div>
  </div>

  <!-- Pagination - Mobile only (separate row) -->
  @if(totalItems > 0) {
  <div class="toolbar-pagination mobile-only">
    <nav class="pagination-controls" role="navigation" aria-label="Pagination">
      <span class="pagination-info" role="status" aria-live="polite">
        {{ getStartIndex() }}-{{ getEndIndex() }} {{ 'toolbar.of' | translate }} {{ totalItems }}
      </span>

      <!-- Page size selector -->
      <button mat-button [matMenuTriggerFor]="pageSizeMenuMobile" class="page-size-btn"
        [matTooltip]="'toolbar.itemsPerPage' | translate"
        [attr.aria-label]="('toolbar.itemsPerPage' | translate) + ': ' + pageSize" aria-haspopup="menu"
        [attr.aria-expanded]="pageSizeMenuOpen">
        <span>{{ pageSize }}</span>
        <mat-icon aria-hidden="true">expand_more</mat-icon>
      </button>
      <mat-menu #pageSizeMenuMobile="matMenu" class="page-size-menu" (opened)="pageSizeMenuOpen = true"
        (closed)="pageSizeMenuOpen = false">
        @for(size of pageSizeOptions; track size) {
        <button mat-menu-item (click)="onPageSizeChange(size)" [class.active]="size === pageSize"
          class="page-size-option" role="menuitemradio" [attr.aria-checked]="size === pageSize"
          [attr.aria-label]="size + ' ' + ('toolbar.itemsPerPage' | translate)">
          <span class="option-value">{{ size }}</span>
          <span class="option-label">{{ 'toolbar.itemsPerPage' | translate }}</span>
          @if(size === pageSize) {
          <mat-icon class="option-check" aria-hidden="true">check</mat-icon>
          }
        </button>
        }
      </mat-menu>

      <button mat-icon-button class="pagination-btn" [disabled]="!hasPreviousPage()" (click)="onPreviousPage()"
        [matTooltip]="'toolbar.previousPage' | translate" [attr.aria-label]="'toolbar.previousPage' | translate">
        <mat-icon aria-hidden="true" class="rtl-flip">chevron_left</mat-icon>
      </button>
      <button mat-icon-button class="pagination-btn" [disabled]="!hasNextPage()" (click)="onNextPage()"
        [matTooltip]="'toolbar.nextPage' | translate" [attr.aria-label]="'toolbar.nextPage' | translate">
        <mat-icon aria-hidden="true" class="rtl-flip">chevron_right</mat-icon>
      </button>
    </nav>
  </div>
  }
</div>

<!-- Floating Action Button (Mobile Only) -->
@if(!hasSelection && !isSearchResultsPage && (showUploadButton || showCreateFolderButton)) {
<div class="fab-container" [class.fab-open]="fabOpen">
  <!-- Main FAB -->
  <button mat-fab color="primary" class="main-fab" (click)="toggleFab()"
    [attr.aria-label]="fabOpen ? ('toolbar.closeActionsMenu' | translate) : ('toolbar.openActionsMenu' | translate)"
    [attr.aria-expanded]="fabOpen">
    <mat-icon [class.fab-icon-rotated]="fabOpen" aria-hidden="true">
      {{ fabOpen ? 'close' : 'add' }}
    </mat-icon>
  </button>

  <!-- Speed Dial Actions -->
  @if(fabOpen) {
  <div class="fab-speed-dial" role="menu" [attr.aria-label]="'toolbar.quickActions' | translate">
    @if(showUploadButton) {
    <div class="speed-dial-item">
      <button mat-mini-fab class="speed-dial-btn upload-dial-btn" (click)="onUploadFilesFromFab()"
        [attr.aria-label]="'toolbar.uploadFiles' | translate" role="menuitem">
        <mat-icon aria-hidden="true">cloud_upload</mat-icon>
      </button>
      <span class="speed-dial-label upload-label">{{ 'toolbar.upload' | translate }}</span>
    </div>
    }

    @if(showCreateFolderButton) {
    <div class="speed-dial-item">
      <button mat-mini-fab class="speed-dial-btn folder-dial-btn" (click)="onCreateFolderFromFab()"
        [attr.aria-label]="'toolbar.createNewFolder' | translate" role="menuitem">
        <mat-icon aria-hidden="true">create_new_folder</mat-icon>
      </button>
      <span class="speed-dial-label folder-label">{{ 'toolbar.newFolder' | translate }}</span>
    </div>
    }
  </div>
  }

  <!-- Backdrop overlay -->
  @if(fabOpen) {
  <div class="fab-backdrop" (click)="closeFab()" aria-hidden="true"></div>
  }
</div>
}

<!-- Mobile Selection Bottom Sheet -->
@if(hasSelection && bottomSheetOpen) {
<div class="selection-bottom-sheet" role="dialog"
  [attr.aria-label]="('common.actions' | translate) + ' ' + ('toolbar.managementToolbar' | translate)"
  aria-modal="true">

  <!-- Backdrop -->
  <div class="bottom-sheet-backdrop" (click)="closeBottomSheet()" aria-hidden="true"></div>

  <!-- Panel -->
  <div class="bottom-sheet-panel">
    <!-- Header -->
    <div class="bottom-sheet-header">
      <div class="drag-handle"></div>
      <h3>{{ 'common.actions' | translate }}</h3>
    </div>

    <!-- Organize Actions -->
    <div class="action-category" role="group" aria-labelledby="organize-heading">
      <div class="action-category-title" id="organize-heading">{{ 'bottomSheet.organize' | translate }}</div>

      <button class="action-item" (click)="onActionSelected('move')" role="menuitem" tabindex="0">
        <mat-icon class="action-item-icon" aria-hidden="true">open_with</mat-icon>
        <span class="action-item-label">{{ 'bottomSheet.moveTo' | translate }}</span>
      </button>

      <button class="action-item" (click)="onActionSelected('copy')" role="menuitem" tabindex="0">
        <mat-icon class="action-item-icon" aria-hidden="true">content_copy</mat-icon>
        <span class="action-item-label">{{ 'bottomSheet.copyTo' | translate }}</span>
      </button>

      <button class="action-item" (click)="onActionSelected('rename')" [disabled]="selectionCount !== 1" role="menuitem"
        tabindex="0" [attr.aria-disabled]="selectionCount !== 1">
        <mat-icon class="action-item-icon" aria-hidden="true">edit</mat-icon>
        <span class="action-item-label">{{ 'common.rename' | translate }}</span>
        @if(selectionCount !== 1) {
        <span class="action-item-meta">{{ 'bottomSheet.oneItemOnly' | translate }}</span>
        }
      </button>
    </div>

    <mat-divider></mat-divider>

    <!-- Share & Download Actions -->
    <div class="action-category" role="group" aria-labelledby="share-heading">
      <div class="action-category-title" id="share-heading">{{ 'bottomSheet.shareAndDownload' | translate }}</div>

      <button class="action-item" (click)="onActionSelected('download')" role="menuitem" tabindex="0">
        <mat-icon class="action-item-icon" aria-hidden="true">download</mat-icon>
        <span class="action-item-label">{{ 'common.download' | translate }}</span>
      </button>
    </div>

    <mat-divider></mat-divider>

    <!-- Danger Zone -->
    <div class="action-category" role="group" aria-labelledby="danger-heading">
      <div class="action-category-title danger-title" id="danger-heading">
        {{ 'bottomSheet.dangerZone' | translate }}
      </div>

      <button class="action-item action-item-danger" (click)="onActionSelected('delete')" role="menuitem" tabindex="0">
        <mat-icon class="action-item-icon" aria-hidden="true">delete</mat-icon>
        <span class="action-item-label">{{ 'common.delete' | translate }}</span>
        <span class="action-item-meta">{{ selectionCount === 1 ? ('bottomSheet.item' | translate:{count: 1}) :
          ('bottomSheet.items' | translate:{count: selectionCount}) }}</span>
      </button>
    </div>
  </div>
</div>
}